<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>هيبة | مولد الأزياء العمانية بالذكاء الاصطناعي</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="مولد الذكاء الاصطناعي للأزياء العمانية التقليدية. اصنع صور أصيلة للدشداشة والبشت والخنجر. Traditional Omani clothing AI generator for authentic dishdasha, bisht, and khanjar designs.">
    <meta name="keywords" content="عمان, أزياء عمانية, دشداشة, بشت, خنجر, ذكاء اصطناعي, Oman, Omani clothing, dishdasha, bisht, khanjar, AI generator, traditional clothing">
    <meta name="author" content="Heiba - هيبة">
    <meta name="robots" content="index, follow">
    <meta name="google-site-verification" content="LzFtldRRazokRREi3lINHaf1aB4GkBikKFaPzi2hvZ4" />
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="هيبة - مولد الأزياء العمانية بالذكاء الاصطناعي">
    <meta property="og:description" content="اصنع صور أصيلة للأزياء العمانية التقليدية بالذكاء الاصطناعي">
    <meta property="og:url" content="https://omani-clothing-ai-generator.vercel.app">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://omani-clothing-ai-generator.vercel.app/logo.png">
    <meta property="og:site_name" content="Heiba - هيبة">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="هيبة - Omani Clothing AI Generator">
    <meta name="twitter:description" content="Generate authentic Omani traditional clothing with AI">
    <meta name="twitter:image" content="https://omani-clothing-ai-generator.vercel.app/logo.png">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://omani-clothing-ai-generator.vercel.app">
    
    <!-- Favicon -->
    <link rel="icon" href="/logo.png" type="image/png"
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Clerk Authentication -->
    <script async crossorigin="anonymous" data-clerk-publishable-key="pk_test_bWVhc3VyZWQtY2hvdy01Ny5jbGVyay5hY2NvdW50cy5kZXYk" src="https://wise-parakeet-29.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js" type="text/javascript"></script>
    
    <style>
        .font-arabic { font-family: 'Noto Sans Arabic', 'Arial Unicode MS', sans-serif; }
        .font-english { font-family: 'Inter', 'Segoe UI', sans-serif; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .sample-image {
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 16px;
            transition: all 0.3s ease;
        }
        
        .sample-image:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .floating-action {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
        }
        
        .history-modal {
            display: none;
        }
        
        .history-modal.active {
            display: flex;
        }
        
        .refined-prompt {
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .refined-prompt.show {
            display: block;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .generation-status {
            display: none;
        }
        
        .generation-status.active {
            display: block;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 font-english">

    <!-- Top Section - Generation Area -->
    <div class="min-h-screen flex flex-col">
        
        <!-- Header -->
        <header class="glass-effect sticky top-0 z-40 px-4 py-3">
            <div class="flex items-center justify-between max-w-7xl mx-auto">
                <!-- Logo -->
                <div class="flex items-center">
                    <img src="logo.png" alt="Logo" class="w-10 h-10 rounded-full">
                </div>
                
                <!-- Account Area -->
                <div class="flex items-center space-x-4 space-x-reverse">
                    <!-- Language Toggle -->
                    <button id="languageToggle" class="px-3 py-2 rounded-full text-sm font-medium bg-white/20 hover:bg-white/30 transition-colors">
                        <span id="languageText">English</span>
                    </button>
                    
                    <!-- Credits Display -->
                    <div id="creditsDisplay" class="hidden px-3 py-2 bg-green-100 rounded-full">
                        <span class="text-sm font-medium text-green-800">
                            <span data-en="Credits:" data-ar="الرصيد:">الرصيد:</span>
                            <span id="creditsCount">0</span>
                        </span>
                    </div>
                    
                    <!-- Auth Button -->
                    <button id="authButton" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full text-sm font-medium transition-colors">
                        <span data-en="Sign In" data-ar="تسجيل الدخول">تسجيل الدخول</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Generation Section -->
        <main class="flex-1 flex items-center justify-center px-4 py-8">
            <div class="w-full max-w-2xl">
                
                <!-- Hero Text -->
                <div class="text-center mb-8">
                    <h1 class="text-4xl md:text-6xl font-bold text-gray-900 mb-4">
                        <span data-en="Create Traditional" data-ar="أنشئ أزياء">أنشئ أزياء</span><br>
                        <span class="gradient-bg bg-clip-text text-transparent" data-en="Omani Fashion" data-ar="عمانية تراثية">عمانية تراثية</span>
                    </h1>
                    <p class="text-xl text-gray-600 mb-6" data-en="AI that perfects the Misar fold, Bisht elegance, and Khanjar shine" data-ar="ذكاء اصطناعي عماني يضبط لفة المِصر وهيبة البشت ولمعة الخنجر">ذكاء اصطناعي عماني يضبط لفة المِصر وهيبة البشت ولمعة الخنجر</p>
                </div>

                <!-- Generation Form -->
                <div class="bg-white/80 backdrop-blur-md rounded-3xl p-6 md:p-8 shadow-xl border border-white/20">
                    
                    <!-- Description Input -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3" data-en="Describe your vision:" data-ar="صف رؤيتك:">صف رؤيتك:</label>
                        <textarea 
                            id="description" 
                            rows="4" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none"
                            data-placeholder-en="Describe the traditional Omani clothing you want to create..."
                            data-placeholder-ar="صف الأزياء العمانية التراثية التي تريد إنشاءها..."
                            placeholder="صف الأزياء العمانية التراثية التي تريد إنشاءها..."></textarea>
                    </div>

                    <!-- Generate Button -->
                    <button id="generateButton" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold rounded-2xl transition-all transform hover:scale-[1.02] active:scale-[0.98] shadow-lg">
                        <span data-en="✨ Generate Traditional Clothing" data-ar="✨ أنشئ الأزياء التراثية">✨ أنشئ الأزياء التراثية</span>
                    </button>

                    <!-- Refined Prompt Display (Initially Hidden) -->
                    <div id="refinedPrompt" class="refined-prompt mt-4 p-4 bg-blue-50 rounded-xl border border-blue-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-blue-800" data-en="🤖 AI Enhanced Prompt:" data-ar="🤖 الوصف المحسن بالذكاء الاصطناعي:">🤖 الوصف المحسن بالذكاء الاصطناعي:</span>
                            <button id="hideRefinedPrompt" class="text-blue-600 hover:text-blue-800 text-xs">✕</button>
                        </div>
                        <p id="refinedPromptText" class="text-sm text-blue-700"></p>
                    </div>

                    <!-- Generation Status -->
                    <div id="generationStatus" class="generation-status mt-4 p-4 bg-amber-50 rounded-xl border border-amber-200 text-center">
                        <div class="animate-spin w-6 h-6 border-2 border-amber-600 border-t-transparent rounded-full mx-auto mb-2"></div>
                        <p class="text-sm text-amber-700" data-en="Creating your traditional Omani clothing..." data-ar="جارٍ إنشاء أزياءك العمانية التراثية...">جارٍ إنشاء أزياءك العمانية التراثية...</p>
                    </div>

                    <!-- Generated Image Display -->
                    <div id="imageResult" class="mt-6 hidden">
                        <div class="relative">
                            <img id="generatedImage" src="" alt="Generated Image" class="w-full rounded-2xl shadow-lg">
                            <button id="downloadImage" class="absolute top-4 right-4 p-2 bg-white/90 hover:bg-white rounded-full shadow-lg transition-colors">
                                <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sample Images Preview -->
                <div class="mt-8 text-center">
                    <button id="viewSamplesButton" class="text-indigo-600 hover:text-indigo-800 font-medium" data-en="👇 View Sample Creations" data-ar="👇 شاهد النماذج">👇 شاهد النماذج</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Sample Images Section -->
    <section id="samplesSection" class="py-16 px-4 bg-white">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-3xl md:text-4xl font-bold text-center mb-12 text-gray-800" data-en="Sample Traditional Creations" data-ar="نماذج من الإبداعات التراثية">نماذج من الإبداعات التراثية</h2>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                <div class="card-hover">
                    <img src="رجل لابس مصر وبشت.jpg" alt="رجل لابس مصر وبشت" class="sample-image w-full">
                    <p class="text-center mt-2 text-sm text-gray-600" data-en="Traditional Misar & Bisht" data-ar="مصر وبشت تراثي">مصر وبشت تراثي</p>
                </div>
                
                <div class="card-hover">
                    <img src="طفل لابس مصر وبشت.jpg" alt="طفل لابس مصر وبشت" class="sample-image w-full">
                    <p class="text-center mt-2 text-sm text-gray-600" data-en="Child in Traditional Wear" data-ar="طفل بالزي التراثي">طفل بالزي التراثي</p>
                </div>
                
                <div class="card-hover">
                    <img src="عائلة رحال لابس مصر وبشت والللطفل لابس بس مصر.jpg" alt="عائلة تراثية" class="sample-image w-full">
                    <p class="text-center mt-2 text-sm text-gray-600" data-en="Traditional Family" data-ar="عائلة تراثية">عائلة تراثية</p>
                </div>
                
                <div class="card-hover">
                    <img src="معرس بشت وخنجر.jpg" alt="معرس بشت وخنجر" class="sample-image w-full">
                    <p class="text-center mt-2 text-sm text-gray-600" data-en="Groom with Bisht & Khanjar" data-ar="معرس ببشت وخنجر">معرس ببشت وخنجر</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section class="py-16 px-4 bg-gray-50">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-3xl md:text-4xl font-bold mb-12 text-gray-800 text-center" data-en="Carefully Designed Features" data-ar="مزايا صُمِّمت بعناية">مزايا صُمِّمت بعناية</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="bg-white p-8 rounded-2xl shadow-lg card-hover">
                    <div class="text-4xl mb-4">🎨</div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-800" data-en="Authentic Details" data-ar="تفاصيل أصيلة">تفاصيل أصيلة</h3>
                    <p class="text-gray-600 leading-relaxed" data-en="Model fine-tuned for traditional Omani clothing with attention to patterns, colors, and Omani features." data-ar="النموذج صنع للأزياء العُمانية الرجالية مع اهتمام بالنقوش والألوان والملامح العمانية.">النموذج صنع للأزياء العُمانية الرجالية مع اهتمام بالنقوش والألوان والملامح العمانية.</p>
                </div>
                
                <div class="bg-white p-8 rounded-2xl shadow-lg card-hover">
                    <div class="text-4xl mb-4">🇴🇲</div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-800" data-en="Made in Oman" data-ar="تراثنا في أيدٍ أمينة">تراثنا في أيدٍ أمينة</h3>
                    <p class="text-gray-600 leading-relaxed" data-en="Developed by an Omani team passionate about preserving the beauty of our traditional attire with cutting-edge technology" data-ar="فريق عُماني يعمل بشغف للحفاظ على رونق لبسنا وتطويره بأحدث التقنيات">فريق عُماني يعمل بشغف للحفاظ على رونق لبسنا وتطويره بأحدث التقنيات</p>
                </div>
                
                <div class="bg-white p-8 rounded-2xl shadow-lg card-hover">
                    <div class="text-4xl mb-4">⏱️</div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-800" data-en="Fast & Reliable" data-ar="سريع وموثوق">سريع وموثوق</h3>
                    <p class="text-gray-600 leading-relaxed" data-en="Most results are completed within seconds to under a minute, depending on service load." data-ar="غالبية النتائج تُنجز خلال ثوانٍ إلى أقل من دقيقة، بحسب الضغط على الخدمة.">غالبية النتائج تُنجز خلال ثوانٍ إلى أقل من دقيقة، بحسب الضغط على الخدمة.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Floating History Button -->
    <button id="historyButton" class="floating-action bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-full shadow-lg transition-all transform hover:scale-110">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
    </button>

    <!-- History Modal -->
    <div id="historyModal" class="history-modal fixed inset-0 bg-black/50 backdrop-blur-sm z-50 items-center justify-center p-4">
        <div class="bg-white rounded-3xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-800" data-en="Your Creation History" data-ar="تاريخ إبداعاتك">تاريخ إبداعاتك</h3>
                    <button id="closeHistoryModal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <div id="historyGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- History items will be populated here -->
                    <div class="text-center text-gray-500 col-span-full py-8" data-en="No generations yet. Create your first traditional clothing!" data-ar="لا توجد إبداعات بعد. أنشئ أول أزياءك التراثية!">لا توجد إبداعات بعد. أنشئ أول أزياءك التراثية!</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8 px-4">
        <div class="max-w-6xl mx-auto text-center">
            <p class="text-sm opacity-80">© 2025 هيبة — صُنع بحب لتراثنا</p>
        </div>
    </footer>

    <!-- Message Display -->
    <div id="messageContainer" class="fixed top-20 right-4 z-50"></div>

    <!-- Soft Notification Popup -->
    <div id="aiMessagePlaceholder" class="hidden fixed bottom-20 left-4 right-4 bg-white/90 backdrop-blur-md border border-blue-200 rounded-2xl p-4 z-40 shadow-xl">
    </div>

    <script>
        // Enhanced OmaniAI class with new features
        class OmaniAI {
            constructor() {
                this.currentLanguage = 'ar';
                this.isAuthenticated = false;
                this.userCredits = 0;
                this.clerk = null;
                this.savedPrompt = '';
                this.init();
            }

            async init() {
                console.log('🚀 Initializing Modern Omani AI Generator...');
                
                await this.initializeClerk();
                this.setupEventListeners();
                this.updateLanguage();
                
                console.log('✅ Modern app initialized successfully');
            }

            async initializeClerk() {
                try {
                    while (!window.Clerk) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    this.clerk = window.Clerk;
                    await this.clerk.load();
                    
                    const session = this.clerk.session;
                    this.isAuthenticated = !!session;
                    this.updateAuthUI(this.isAuthenticated);
                    
                    if (this.isAuthenticated) {
                        await this.loadUserCredits();
                        await this.loadUserHistory();
                    }
                    
                    this.clerk.addListener(({ session }) => {
                        const wasAuthenticated = this.isAuthenticated;
                        this.isAuthenticated = !!session;
                        
                        if (this.isAuthenticated !== wasAuthenticated) {
                            this.updateAuthUI(this.isAuthenticated);
                            if (this.isAuthenticated) {
                                this.loadUserCredits();
                                this.loadUserHistory();
                                // Restore saved prompt if exists
                                if (this.savedPrompt) {
                                    document.getElementById('description').value = this.savedPrompt;
                                    this.savedPrompt = '';
                                }
                            } else {
                                this.userCredits = 0;
                                this.updateCreditsDisplay();
                            }
                        }
                    });
                    
                } catch (error) {
                    console.error('Failed to initialize Clerk:', error);
                }
            }

            setupEventListeners() {
                // Language toggle
                document.getElementById('languageToggle')?.addEventListener('click', () => {
                    this.toggleLanguage();
                });

                // Auth button
                document.getElementById('authButton')?.addEventListener('click', () => {
                    this.handleAuth();
                });

                // Generate button
                document.getElementById('generateButton')?.addEventListener('click', () => {
                    this.handleGenerate();
                });

                // View samples scroll
                document.getElementById('viewSamplesButton')?.addEventListener('click', () => {
                    document.getElementById('samplesSection').scrollIntoView({ behavior: 'smooth' });
                });

                // History button
                document.getElementById('historyButton')?.addEventListener('click', () => {
                    this.openHistoryModal();
                });

                // Close history modal
                document.getElementById('closeHistoryModal')?.addEventListener('click', () => {
                    this.closeHistoryModal();
                });

                // Hide refined prompt
                document.getElementById('hideRefinedPrompt')?.addEventListener('click', () => {
                    this.hideRefinedPrompt();
                });

                // Download image
                document.getElementById('downloadImage')?.addEventListener('click', () => {
                    this.downloadImage();
                });
            }

            toggleLanguage() {
                this.currentLanguage = this.currentLanguage === 'en' ? 'ar' : 'en';
                this.updateLanguage();
            }

            updateLanguage() {
                const html = document.documentElement;
                const languageText = document.getElementById('languageText');
                const description = document.getElementById('description');

                if (this.currentLanguage === 'ar') {
                    html.setAttribute('dir', 'rtl');
                    html.setAttribute('lang', 'ar');
                    html.classList.add('font-arabic');
                    html.classList.remove('font-english');
                    if (languageText) languageText.textContent = 'English';
                    
                    if (description) {
                        description.placeholder = description.getAttribute('data-placeholder-ar');
                    }
                } else {
                    html.setAttribute('dir', 'ltr');
                    html.setAttribute('lang', 'en');
                    html.classList.add('font-english');
                    html.classList.remove('font-arabic');
                    if (languageText) languageText.textContent = 'عربي';
                    
                    if (description) {
                        description.placeholder = description.getAttribute('data-placeholder-en');
                    }
                }

                document.querySelectorAll('[data-en][data-ar]').forEach(element => {
                    const text = this.currentLanguage === 'ar' 
                        ? element.getAttribute('data-ar')
                        : element.getAttribute('data-en');
                    element.textContent = text;
                });

                console.log(`🌐 Language updated to: ${this.currentLanguage}`);
            }

            // Authentication methods
            handleAuth() {
                if (this.isAuthenticated) {
                    this.signOut();
                } else {
                    this.signIn();
                }
            }

            async signIn() {
                try {
                    if (this.clerk) {
                        await this.clerk.openSignIn();
                    }
                } catch (error) {
                    console.error('Sign in failed:', error);
                    this.showMessage('Sign in failed', 'error');
                }
            }

            async signOut() {
                try {
                    if (this.clerk) {
                        await this.clerk.signOut();
                        this.showMessage(
                            this.currentLanguage === 'ar' ? 'تم تسجيل الخروج بنجاح' : 'Signed out successfully', 
                            'success'
                        );
                    }
                } catch (error) {
                    console.error('Sign out failed:', error);
                    this.showMessage(
                        this.currentLanguage === 'ar' ? 'فشل تسجيل الخروج' : 'Sign out failed', 
                        'error'
                    );
                }
            }

            updateAuthUI(authenticated) {
                const authButton = document.getElementById('authButton');
                const creditsDisplay = document.getElementById('creditsDisplay');

                if (authenticated) {
                    authButton.innerHTML = this.currentLanguage === 'ar' 
                        ? 'تسجيل الخروج' 
                        : 'Sign Out';
                    creditsDisplay?.classList.remove('hidden');
                } else {
                    authButton.innerHTML = this.currentLanguage === 'ar' 
                        ? 'تسجيل الدخول' 
                        : 'Sign In';
                    creditsDisplay?.classList.add('hidden');
                }
            }

            // Credits management
            async loadUserCredits() {
                try {
                    const response = await fetch('/api/credits');
                    if (response.ok) {
                        const data = await response.json();
                        this.userCredits = data.credits;
                        this.updateCreditsDisplay();
                    }
                } catch (error) {
                    console.error('Failed to load credits:', error);
                }
            }

            updateCreditsDisplay() {
                const creditsCount = document.getElementById('creditsCount');
                if (creditsCount) {
                    creditsCount.textContent = this.userCredits;
                }
            }

            // Image generation
            async handleGenerate() {
                if (!this.isAuthenticated) {
                    // Save prompt for after login
                    this.savedPrompt = document.getElementById('description').value;
                    
                    this.showMessage(
                        this.currentLanguage === 'ar' 
                            ? 'يرجى تسجيل الدخول أولاً' 
                            : 'Please sign in first',
                        'warning'
                    );
                    await this.signIn();
                    return;
                }

                if (this.userCredits <= 0) {
                    this.showMessage(
                        this.currentLanguage === 'ar' 
                            ? 'رصيدك منتهي' 
                            : 'No credits remaining',
                        'warning'
                    );
                    return;
                }

                const description = document.getElementById('description').value.trim();
                if (!description) {
                    this.showMessage(
                        this.currentLanguage === 'ar' 
                            ? 'يرجى إدخال وصف للأزياء' 
                            : 'Please enter a description',
                        'warning'
                    );
                    return;
                }

                const prompt = description;

                this.showGenerationStatus(true);
                this.hideRefinedPrompt();
                this.hideImageResult();

                try {
                    // 1. First, check for notifications immediately
                    const notificationPromise = fetch('/api/notifications', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    }).then(async (response) => {
                        if (response.ok) {
                            const data = await response.json();
                            if (data.notification) {
                                // Show notification immediately while image is generating
                                this.showSoftNotification(data.notification);
                            }
                        }
                    }).catch(error => {
                        console.warn('Notification check failed:', error);
                    });

                    // 2. Start image generation (this will take longer)
                    const generatePromise = fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });

                    // Execute notification check immediately
                    notificationPromise;

                    // Wait for image generation
                    const response = await generatePromise;
                    const data = await response.json();

                    if (response.ok) {
                        // Show refined prompt
                        this.showRefinedPrompt(data.enhancedPrompt);
                        
                        // Show generated image
                        this.showImageResult(data.imageUrl);
                        
                        // Update credits
                        this.userCredits = data.remainingCredits;
                        this.updateCreditsDisplay();
                        
                        // Reload history
                        await this.loadUserHistory();
                        
                        this.showMessage(
                            this.currentLanguage === 'ar' 
                                ? 'تم إنشاء الصورة بنجاح!' 
                                : 'Image generated successfully!',
                            'success'
                        );
                    } else {
                        throw new Error(data.error || 'Generation failed');
                    }
                } catch (error) {
                    console.error('Generation error:', error);
                    this.showMessage(
                        this.currentLanguage === 'ar' 
                            ? 'فشل في إنشاء الصورة' 
                            : 'Failed to generate image',
                        'error'
                    );
                } finally {
                    this.showGenerationStatus(false);
                }
            }

            showRefinedPrompt(prompt) {
                const container = document.getElementById('refinedPrompt');
                const text = document.getElementById('refinedPromptText');
                
                if (container && text) {
                    text.textContent = prompt;
                    container.classList.add('show');
                }
            }

            hideRefinedPrompt() {
                const container = document.getElementById('refinedPrompt');
                if (container) {
                    container.classList.remove('show');
                }
            }

            showImageResult(imageUrl) {
                const container = document.getElementById('imageResult');
                const image = document.getElementById('generatedImage');
                
                if (container && image) {
                    image.src = imageUrl;
                    container.classList.remove('hidden');
                }
            }

            hideImageResult() {
                const container = document.getElementById('imageResult');
                if (container) {
                    container.classList.add('hidden');
                }
            }

            showGenerationStatus(show) {
                const status = document.getElementById('generationStatus');
                if (status) {
                    if (show) {
                        status.classList.add('active');
                    } else {
                        status.classList.remove('active');
                    }
                }
            }

            // History management
            async loadUserHistory() {
                if (!this.isAuthenticated) return;

                try {
                    const response = await fetch('/api/history');
                    if (response.ok) {
                        const data = await response.json();
                        this.updateHistoryGrid(data.generations || []);
                    }
                } catch (error) {
                    console.error('Failed to load history:', error);
                }
            }

            updateHistoryGrid(generations) {
                const grid = document.getElementById('historyGrid');
                if (!grid) return;

                if (generations.length === 0) {
                    grid.innerHTML = `
                        <div class="text-center text-gray-500 col-span-full py-8" data-en="No generations yet. Create your first traditional clothing!" data-ar="لا توجد إبداعات بعد. أنشئ أول أزياءك التراثية!">
                            ${this.currentLanguage === 'ar' ? 'لا توجد إبداعات بعد. أنشئ أول أزياءك التراثية!' : 'No generations yet. Create your first traditional clothing!'}
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = generations.map(gen => `
                    <div class="bg-white rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition-shadow">
                        <div class="aspect-square">
                            <img src="${gen.image_url}" alt="${gen.prompt}" class="w-full h-full object-cover">
                        </div>
                        <div class="p-3">
                            <p class="text-xs text-gray-600 truncate">${gen.prompt}</p>
                            <p class="text-xs text-gray-400 mt-1">${new Date(gen.created_at).toLocaleDateString()}</p>
                        </div>
                    </div>
                `).join('');
            }

            openHistoryModal() {
                if (!this.isAuthenticated) {
                    this.showMessage(
                        this.currentLanguage === 'ar' 
                            ? 'يرجى تسجيل الدخول لرؤية التاريخ' 
                            : 'Please sign in to view history',
                        'warning'
                    );
                    return;
                }

                const modal = document.getElementById('historyModal');
                if (modal) {
                    modal.classList.add('active');
                }
            }

            closeHistoryModal() {
                const modal = document.getElementById('historyModal');
                if (modal) {
                    modal.classList.remove('active');
                }
            }

            // Utility methods
            downloadImage() {
                const image = document.getElementById('generatedImage');
                if (image && image.src) {
                    const link = document.createElement('a');
                    link.href = image.src;
                    link.download = `omani-traditional-clothing-${Date.now()}.webp`;
                    link.click();
                }
            }

            showMessage(message, type = 'info') {
                const container = document.getElementById('messageContainer');
                if (!container) return;

                const messageEl = document.createElement('div');
                const bgColor = {
                    success: 'bg-green-100 border-green-300 text-green-800',
                    error: 'bg-red-100 border-red-300 text-red-800',
                    warning: 'bg-amber-100 border-amber-300 text-amber-800',
                    info: 'bg-blue-100 border-blue-300 text-blue-800'
                };

                messageEl.className = `${bgColor[type]} px-4 py-3 rounded-xl border mb-2 transform translate-x-full transition-transform duration-300`;
                messageEl.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-sm">${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-current opacity-70 hover:opacity-100">✕</button>
                    </div>
                `;

                container.appendChild(messageEl);

                // Slide in
                setTimeout(() => {
                    messageEl.classList.remove('translate-x-full');
                }, 10);

                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.classList.add('translate-x-full');
                        setTimeout(() => messageEl.remove(), 300);
                    }
                }, 5000);
            }

            // Soft notification popup for AI feedback
            showSoftNotification(message) {
                const container = document.getElementById('aiMessagePlaceholder');
                if (!container) return;

                // Update content
                container.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3 rtl:space-x-reverse">
                            <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <span class="text-blue-800 text-sm font-medium">${message}</span>
                        </div>
                        <button onclick="this.parentElement.parentElement.classList.add('hidden')" class="text-blue-400 hover:text-blue-600 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `;

                // Show with animation
                container.classList.remove('hidden');
                container.style.transform = 'translateY(100%)';
                container.style.opacity = '0';
                
                setTimeout(() => {
                    container.style.transform = 'translateY(0)';
                    container.style.opacity = '1';
                    container.style.transition = 'all 0.3s ease-out';
                }, 10);

                // Auto hide after 8 seconds (longer for notifications)
                setTimeout(() => {
                    container.style.transform = 'translateY(100%)';
                    container.style.opacity = '0';
                    setTimeout(() => {
                        container.classList.add('hidden');
                    }, 300);
                }, 8000);
            }
        }

        // Initialize the app
        const app = new OmaniAI();
    </script>
</body>
</html>
